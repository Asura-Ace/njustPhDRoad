# 答辩PPT演讲稿

欢迎各位老师参加我的博士学位论文答辩。我今天答辩的题目是《基于变分和稀疏表示的定量MR图像快速重建模型和加速算法》

---
我们先来看引言部分。

核磁共振图像，尤其是动态MRI和定量MRI是医学临床和研究中常用的成像方式。例如，下面三幅图像均为动态MRI的一帧图像。第一张图像为磁共振动态造影增强图像，它是定量MRI的重要应用，被成功应用在胸部肿瘤定量分析中。第二张图像为心脏灌注图像。第三张图像是磁共振指纹图像，它是近年来定量MRI的研究热点，可以在单次数据采集中同时获取多组定量参数。我们将在后边具体介绍胸部磁共振动态造影增强图像和磁共振指纹图像。

MR成像的过程通常被建模为二维或三维空间的Fourier编码，即首先从图像的Fourier域(通常称为 k-space)中采样，再通过算法将图像重建出来。动态MR成像的数学模型如方程1所示：对于一副动态MR图像X，其含有d帧图像，每帧图像的维度为N1乘以N2，则动态MR成像的过程相当于在噪声的干扰下，在Fourier域中进行采样。其中A为采样算子，F是作用在每一帧图像上的二维Fourier变换，M是作用在每一帧图像上的二维采样模式，epsilon是加性高斯白噪声。由于物理和生理上的限制，MR图像，尤其是动态MR图像的成像速度很慢。如何在保证图像质量的前提下，提高成像速度一直是研究人员关心的问题。

目前，基于压缩感知理论的MR重建是快速MR成像的主流方法。压缩感知理论是由Candes等提出的采样理论，理论假设图像在某个变换域内稀疏的前提下，对图像进行非相干下采样，通过非线性重建算法可以高概率地将图像重建出来。基于压缩感知理论的动态MR图像重建模型如方程2所示，其中phi是某个稀疏变换。这里A为下采样算子，由于我们减少了采样数据，从而达到了加速成像的效果。

目前，常用的稀疏表示有Fourier变换、小波变换、多尺度分析、全变差、广义全变差、核范数，还有基于学习的方法，如字典学习和最近比较火热的深度神经网络等。MR重建常用的采样方式有Cartesian采样、伪径向采样、径向采样、螺旋采样等。如下图所示。其中白色的线是采集到的点，黑色的线是没有采集的点。其中Cartesian采样和伪径向采样的采样点均在Cartesian网格上，计算简便；径向采样和螺旋采样的采样点分别沿着径向和螺旋线进行采样，计算较繁琐，但可以达到较高的下采样率。常用的重建算法有ADMM、FISTA、Primal-Dual等。

本文的研究动机主要有以下三点。第一，动态MR重建速度慢，比如磁共振动态对比增强图像、磁共振指纹成像中字典生成与参数图的重建等。第二，现有的动态MR图像重建模型存在空间伪影严重、边缘不清、像素时间曲线拟合差等问题，尤其在胸部DCE-MRI图像上。第三，临床上适用于胸部DCE-MRI的时间方向的稀疏表示时未知的。针对以上问题，本文的研究成果有以下三方面。第一，针对动态MR图像，结合压缩感知和图像分解的思想，提出了基于二阶时空TGV和核范数的重建模型。第二，通过定量分析的方式比较和评估了五种不同的时间方向的稀疏表示，确定了适用于胸部DCE-MRI的时间稀疏正则项。第三，利用图像处理单元加速磁共振指纹的字典生成与匹配，并设计开发了一款基于CUDA框架的开源程序snapMRF。

---
我们首先看第一个工作

将压缩感知和图像分解相结合是动态MR重建的经典模型之一。图像分解模型的思想是将动态MR建模为稀疏部分和低秩部分的加和，并用不同的正则项来约束。如方程3所示。其中L为低秩部分，用来建模时间方向高度相关的图像背景；S为稀疏部分，用来建模背景之上的动态信息。对于动态图像而言，一方面其背景部分通常随时间变化缓慢，即在时间方向高度相关，这导致了背景部分的低秩性;另一方面其前景部分通常随着时间变化，而且前景部分相对于整幅图像通常比例很小，这导致了前景部分的稀疏性。这样处理的好处是，将背景部分从动态图像中减掉之后，剩下的前景部分会比原图像更加稀疏，因此也更加符合压缩感知理论的条件。这里核范数是矩阵奇异值的和，是矩阵的秩的凸松弛。根据不同的问题，稀疏变换phi的选择有如下几种。时间方向一维Fourier变换，但其仅适用于具有周期性的图像，如心脏电影成像中，心脏周期性的搏动。时间方向的梯度算子，但其仅仅利用了时间方向的稀疏性。对于动态MR图像而言，其冗余性不仅体现在时间上，也体现在空间上，并且时间分辨率和空间分辨率同样重要，高时间分辨率有利于精确地定量分析，而高空间分辨率有助于医生的临床阅读。全变差，但其易于产生阶梯效应并且模型的计算速度慢。

TGV泛函是经典TV泛函的高阶推广，可以有效地抑制阶梯效应。二阶时空TGV泛函的定义如下，其中epsilon是对称梯度算子，合理梯度3包含了三个方向的梯度，既有时间又有空间，所以我们称之为二阶时空TGV。

针对动态MR图像，基于图像分解和压缩感知的思想，我们提出二阶时空TGV和核范数的模型。可以看出，模型是凸的、适定的。其中核范数用来建模时间上高度相关的背景，二阶时空TGV泛函用来建模背景之上的动态信息。

我们使用Primal-Dual算法来求解模型。Primal-Dual算法被广泛地应用到寻找凸-凹鞍点问题的极大极小问题中。其中K为线性连续映射，泛函f和g是适定的、凸的、下办连续的。其Chambolle-Pock迭代格式如下所示，依次更新对偶变量、主变量和中间变量，直到收敛。这里sigma和tau是迭代步长。

为了求解模型，我们首先需要将TGV泛函离散化，并将其转换成相应的鞍点问题。其中pq和lambda为对偶变量。

将鞍点问题转换为结构5，将K写成算子矩阵的形式，将所有的主变量放到f中，所有的对偶变量放到g中，于是模型的求解过程如算法1所示

其中前三步为更新对偶变量，中间三步为更新主变量，最后三步为更新中间变量，直到收敛。

我们也估计了算法收敛时算子范数的大小。当迭代步长满足（）时，算法收敛。经计算可以得到如下的估计。

我们将提出的模型与其他四个经典的动态MR重建模型进行了比较，这里zerofilled是补零重建的结果。我们在五组数据上进行了数值实验，分别问躯干体模、心脏灌注和三组不同的胸部数据。在这组实验中，我们选取了伪径向的采样模式，如图所示。可以看出，除了躯干体模数据，我们的模型在其他的数据中都取得了最高的信噪比和结构相似性测度，在胸部DCE-MRI图像上的优势尤其明显。

这张图展示了各个模型在躯干体模数据上的重建结果。第一行为重建图像，第二行为红色方框区域的放大图像，第三行为相对于原图像的差值图像。重点看红色箭头，虽然kt-SLR取得了最高的信噪比，但其重建图像中仍残留有空间伪影。蓝色箭头表明我们的模型在保持边缘方面的效果明显。

这张图展示了各个模型在胸部1的重建结果。我们的模型不仅取得了最高的信噪比和结构相似性测度，蓝色箭头表明我们的模型也可以很好地抑制空间伪影，红色箭头则表明我们的模型可以很好地重建肿瘤区域。

为了展示胸部肿瘤随时间的变化，我们也绘制了胸部1肿瘤区域的平均像素时间曲线。这里，平均像素时间曲线是指肿瘤区域，即红色方框的平均像素值随时间的变化曲线，这是胸部图像肿瘤区域重建效果的常用评价方法之一。可以看到， 我们的模型在造影剂注入之前，即前10-15帧和之后都可以很好地拟合曲线，并且拟合的方差较低。其他的方法拟合的效果则一般，有的不能很好地拟合前10-15帧，有的不能拟合最后几帧，有的拟合方差较大。

为了测试各个模型在不同下采样率下的表现，我们同样在伪径向采样模式下，选择了五个不同数量的采样线。这个表格展示了不同模型在不同下采样率下在胸部1上的表现。可以看出，我们的模型依然得到最高的信噪比和结构相似性，这表明了模型的一致性。

我们也比较了各个模型在Cartesian采样模式下的重建结果，如右图所示。可以看出，我们的模型得到了最高的信噪比和结构相似性测度，而其他的模型在 Cartesian采样模式下的表现不理想。同时，我们也比较了各个模型在胸部1数据上的运行时间，可以看出我们的GPU加速的版本只需要28秒左右，远远快于其他模型，相对于CPU的版本也有了100倍的加速。

---
下面我们看第二个工作

DCE-MRI图像通过测量注入造影剂期间和之后的信号，使得图像的每个体素产生一个时间强度曲线，用于定量地估计生理参数，例如体积转移常数和血管外细胞体积分数等。如下图所示，我们最关心的是肿瘤区域的定量参数。这些定量参数有助于给医生提供客观的标准，从而减少了主观性，起到了帮助癌症诊断、评估和治疗的作用。

虽然压缩感知理论已经应用在胸部DCE-MRI图像上，但在应用到临床之前，其可靠性和准确性的研究是必要的。本文首次通过量化分析的方式比较和评估了五种不同的时间方向的稀疏变换在压缩感知模型中的表现，分别为时间方向的Fourier变换、时间方向的小波变换、时间方向的梯度算子、时间方向的TGV、核范数。这里TGV也只为时间方向的。

我们在一组胸部DCE-MRI图像上进行数值实验。我们首先随机生成200个下采样率相同的Cartesian采样模式，然后使用FISTA算法进行图像重建。得到重建图像后，我们使用标准Tofts-Kely模型计算肿瘤区域的ktrans与ve的值。评价方法为重建图像的信噪比和肿瘤区域定量参数的一致性相关系数。

这个表显示了重建图像的平均信噪比和平均一致性相关项系数。可以看出核范数得到了最高的信噪比，而TV/TGV得到了最高的一致性相关系数。

这张图是Ktrans和ve参数图肿瘤部分放大后的图像。在视觉上，TV和TGV都精确地重建出Ktrans和ve，与全采样的参数图最接近，没有任何去噪与模糊的效果。而NN的参数图像则变得模糊，有过平滑的效果。

我们同样也比较了重建图像肿瘤区域像素时间曲线，其中上图是肿瘤区域平均像素值的时间曲线，下图是肿瘤中心像素点的时间曲线。可以看出TV和TGV最好地拟合了肿瘤区域的平均像素值时间曲线。Fourier变换在最初和最后的几帧的拟合效果很差，小波变换低估了肿瘤区域的平均像素值。

我们也展示了ktrans和ve的箱型图。在所有的箱式图中，四分位的范围都很小，说明对于胸部DCE-MRI，基于Cartesian采样模式的压缩感知重建有可预测的精度。从前两个箱型图中可以看出，除了TV与TGV，所有结果在统计上都有显著性差异，并且TV与TGV得到了最精确的结果。在后两个箱型图中，红色的水平线代表了肿瘤平均ktrans和ve的真实值。同样，TV与TGV得到了最准确的肿瘤平均ktrans和ve，与真实值最接近。

总结一下，我们得出结论：对于胸部DCE-MRI图像，TV与TGV在统计上没有显著性差异，并得到了最准确的定量分析；核范数得到了最高的信噪比。因此，对于那些需要得到更加精确整体质量的应用，最好的稀疏项选择是核范数；如果需要得到更精确的参数分析，最好的选择是TV或者TGV。

---
最后一部分是基于GPU的实时MRF字典生成与参数图重建。

磁共振指纹是一种新的定量MRI方法，可以在单词数据采集中同时获取多个组织参数，如T1、T2、质子密度等。这张图展示了磁共振指纹重建参数图的流程。首先我们应该选取对所研究参数敏感（如T1、T2）的MR序列对信号进行采样，并且序列的参数，如重复时间等需要随着时间随机变化，使得组织在MR序列中产生指纹状的信号演化。其次，利用MR成像的数学模型，生成一个包含信号演化的字典，字典中的每一个元素都模拟了不同参数的组织在该MR序列下的演化，即每一个元素中都包含着组织的参数信息。最后，使用模式识别算法将采集的信号与字典中的元素进行匹配，选择最匹配的元素，而这个元素中即包含了该体素的参数信心，从而得到参数图。

这张图给出了磁共振指纹图像的例子。左上角是某个时刻采集到的指纹数据，后面五张图像均为重建出的参数图。磁共振图像重建参数图的过程即为从指纹数据中重建参数图的过程。本文，我们主要关注T1、T2和质子密度。

目前，磁共振指纹主要的问题是字典生成与匹配十分耗时。在字典生成中，扩展相图模型是最常用的模型，它是描述和理解磁化在不同MR序列中响应的有力工具，梯度场、射频场、驰豫等对磁化的作用都可以用矩阵的简单计算来实现。但是扩展相图模型十分复杂且耗时。匹配算法最常用的算法是模板匹配算法。设X为指纹数据，其时间点的个数为L，体素点的个数为N，字典中的元素为K，则模板匹配算法是从字典中选取内积最大的元素，同时也可以得到质子密度。可以看到，模板匹配算法的复杂度为（），十分耗时。

目前，图形处理单元逐渐成为加速科学计算的主流方法，在医学成像领域有着广泛的应用。GPU中集成了大规模并行计算单元，可以用于浮点运算。目前最常用的编程接口是英伟达公司的CUDA框架，本文首次在CUDA框架下，利用GPU实现并行加速MRF字典生成与模板匹配，并设计开发了一款开源程序snapMRF。

程序的流程如图所示。首先将数据从CPU读入GPU，之后所有的计算都在GPU上进行，避免了数据在CPU与GPU之间的多次拷贝，节省了时间。然后利用EPG算法生成字典并进行匹配，最后保存结果。其详细的过程如算法2所示。其中第三步到第12步是利用EPG算法进行字典匹配的过程，也是整个程序设计的难点。我们以作用矩阵为单位，将整个EPG算法分裂成几个小的GPU核函数，每个核函数只对应一个作用矩阵，如射频场、梯度场和驰豫的作用。第二个难点是显存的管理。在进行字典匹配之前，我们释放了没用的显存，如状态矩阵dw，并且计算了此时剩余显存的大小，然后根据剩余显存的大小将指纹数据均匀地分成了几组，在每个小组内进行字典匹配。这样做的原因是字典和指纹数据通常需要占据很大的显存，因此通常没有足够的显存同时计算所有的体素参数图。

程序设计中的其他难点还有很多，比如确定一个合适的并行方案。在生成字典的过程中，并行是相对于字典中的元素而言的，也就是说，在每一个时间点，并行计算所有元素的信号。在进行字典匹配时，并行是相对于指纹数据的体素而言的，并行计算每一小组内所有体素的参数图。下一个难点是确定多维向量在显存中的存储结构，即多维向量指标变化的快慢。对于包含时间维度的向 量指针，如 d_atoms、d_mrf、d_img 等，我们选取时间维度优先，即时间方向的指 标变化最快。对于包含参数维度的向量指针，如 d_maps、d_params 等，我们选取参数维度优先，即参数方向的指标变化最快。这样做的好处是加快数据在显存中的访问速度。最后一个难点是计算多维向量在显存中的一维指标。字典、指纹等数据虽然为多维数据， 但其在显存中的储存和访问只能是一维线性的。因此，多维数据的指标和其在显存中的 一维指标需要一一对应起来。这个过程并不容易且至关重要，因为一旦指标计算错误， 最后的结果会变得无法预测且这种错误很难被发现。

我们比较了snapMRF与其他MRF重建程序的运行时间。其中EPG-X是用MATLAB编写的程序，而PnP-MRF使用C语言编写的程序。注意图像中的曲线为对数尺度下的曲线。可以看出snapMRF在整体上字典生成的速度提高了10–1000倍，而模板匹配的速度提高了10–100倍。程序运行的速度有了显著的提高。

这个表格展示了snapMRF与EPG-X在体模数据和脑部数据上字典生成与模板匹配的运行时间比较。其中字典大小为1000乘以十万，指纹大小为1000乘以240乘以240。snapMRF可以在15 s内生成大小为100,000的字典并进行模板匹配，速度远远大于EPG-X，并且snapMRF可以处理多种不同成像参数的MR序列，比如固定TR，变化TR，变化TR加B1修正等，而EPG-X只能处理固定TR的序列。

这两个表格展示了snapMRF和EPG-X在体模数据重建生成的T1和T2与对应的相对误差。对于固定 TR 序列，snapMRF 与 EPG-X 的精度是几乎一样的，并且变化TR序列和B1校正有助于提高参数图的准确性。

这个图显示了snapMRF和EPG-X在体模数据上生成的T1、T2和质子密度参数图。对于固定TR序列，snapMRF和EPG-X所生成的参数图在视觉上几乎一致。对于变化TR序列，T1参数图有所提高，而T2参数图保持不变。当考虑B1校正时，T2参数图也有了明显的提升。

这个图显示了snapMRF和EPG-X在活体人脑数据上生成的T1、T2和质子密度参数图。对于所有序列，snapMRF都可以生成高质量的参数图。

---
总结一下，本文的工作主要有以下三个方面。第一，提出了动态MR的重建模型，二阶时空TGV加核范数的模型，其效果优于其他的重建模型，尤其是在胸部DCE-MRI图像上。第二，首次从定量分析的角度评估胸部DCE-MRI图像的时间方向的稀疏正则项，其中TV/TGV 可以得到最准确的定量参数，核范数可以提高重建图像的整体信噪比；第三，首次在CUDA框架下进行MRF字典生成和匹配，snapMRF的字典生成的速度提高了10–1000倍，模板匹配的速度提高了10–100倍，并在多种MR序列中都可以生成高质量的参数图。下一步的工作包括以下两个方面。第一，最近几年深度神经网络变得十分火热。虽然已经有一些模型被应用到了动态MR图像重建中，但从整体上说还处于刚刚起步阶段。我们会考虑将变分模型与深度神经网络相结合来处理动态MR图像的重建。
第二个未来工作将模型应用到其他类型的医学成像中，如低剂量CT成像、PET成像等。

谢谢大家。